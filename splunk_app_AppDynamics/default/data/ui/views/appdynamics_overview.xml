<form>
  <label>Overview</label>
  <description>APM Data from Appdynamics</description>
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="myTime" searchWhenChanged="true">
      <label>Time Period</label>
      <default>
        <earliest>-60m@m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="app" searchWhenChanged="true">
      <label>Applications</label>
      <choice value="*">All</choice>
      <fieldForLabel>application_name</fieldForLabel>
      <fieldForValue>application_id</fieldForValue>
      <search>
        <query>sourcetype=appdynamics_summary | spath application_id | dedup application_name  | table  application_id application_name | sort application_name</query>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </search>
      <default>*</default>
      <initialValue>*</initialValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>End User Experience Metrics</title>
      <input type="dropdown" token="eum_metric" searchWhenChanged="true">
        <label>Metric</label>
        <default>End User Response Time (ms)</default>
        <initialValue>End User Response Time (ms)</initialValue>
        <fieldForLabel>column</fieldForLabel>
        <fieldForValue>column</fieldForValue>
        <search>
          <query>sourcetype=appdynamics_summary  source=end_user_experience application_id=$app$
 | stats dc() as * | transpose</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
      </input>
      <chart>
        <search>
          <query>sourcetype=appdynamics_summary  source=end_user_experience application_id=$app$

| timechart  avg("$eum_metric$") as "Average"</query>
          <earliest>$myTime.earliest$</earliest>
          <latest>$myTime.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">connect</option>
      </chart>
    </panel>
    <panel>
      <title>Overall Application Performance Metrics</title>
      <input type="dropdown" searchWhenChanged="true" token="apm_metric">
        <label>Metric</label>
        <fieldForLabel>column</fieldForLabel>
        <search>
          <query>sourcetype=appdynamics_summary  source=application_performance application_id=$app$
 | stats dc() as * | transpose</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <initialValue>Average Response Time (ms)</initialValue>
        <fieldForValue>column</fieldForValue>
        <default>Average Response Time (ms)</default>
      </input>
      <chart>
        <search>
          <query>sourcetype=appdynamics_summary  source=application_performance application_id=$app$

| timechart  avg("$apm_metric$") as "Average"</query>
          <earliest>$myTime.earliest$</earliest>
          <latest>$myTime.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries">1</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisStart</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Infrastructure  Performance Metrics</title>
      <input type="dropdown" token="infr_metric" searchWhenChanged="true">
        <label>Metric</label>
        <default>App-Availability</default>
        <fieldForLabel>column</fieldForLabel>
        <fieldForValue>column</fieldForValue>
        <search>
          <query>sourcetype=appdynamics_summary  source=infrastructure_performance application_id=$app$

 | stats dc() as * | transpose | sort column</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <initialValue>App-Availability</initialValue>
      </input>
      <chart>
        <search>
          <query>sourcetype=appdynamics_summary  source=infrastructure_performance application_id=$app$


| timechart  avg("$infr_metric$") as "Average"</query>
          <earliest>$myTime.earliest$</earliest>
          <latest>$myTime.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">connect</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Policy Violations</title>
      <input type="dropdown" token="v_status">
        <label>Status</label>
        <choice value="*">All</choice>
        <choice value="OPEN">Open</choice>
        <choice value="RESOLVED">Resolved</choice>
        <default>OPEN</default>
        <initialValue>OPEN</initialValue>
      </input>
      <input type="dropdown" token="v_severity">
        <label>Severity</label>
        <choice value="*">All</choice>
        <choice value="CRITICAL">Critical</choice>
        <choice value="WARNING">Warning</choice>
        <default>CRITICAL</default>
        <initialValue>CRITICAL</initialValue>
      </input>
      <table>
        <search>
          <query>sourcetype=appdynamics_summary  source=healthrule_violations 

application_id=$app$ 

|  spath path=healthrule_violations{} output=names 
| fields - _raw 
| fields  application_name names | mvexpand names 
| spath input=names 
| eval start_time=strftime(startTimeInMillis/1000, "%F %T.%2N")

| search incidentStatus = "$v_status$" AND severity="$v_severity$"

| table application_name incidentStatus severity name start_time  description deepLinkUrl</query>
          <earliest>$myTime.earliest$</earliest>
          <latest>$myTime.latest$</latest>
        </search>
        <format type="color" field="severity">
          <colorPalette type="map">{"WARNING":#F7BC38,"CRITICAL":#D93F3C}</colorPalette>
        </format>
        <format type="color" field="incidentStatus">
          <colorPalette type="map">{"OPEN":#D93F3C,"CLOSED":#555555}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
</form>